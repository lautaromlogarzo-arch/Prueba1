<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Suspensi√≥n FSAE 3D - Realista</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    
    <style>
        :root { --primary: #d62828; --dark: #003049; --light: #fdf0d5; --accent: #669bbc; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background: #edf2f4; display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .sidebar { width: 420px; background: #fff; overflow-y: auto; padding: 20px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 10; display: flex; flex-direction: column; border-right: 1px solid #ddd; }
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; }
        .viz-container { flex: 1; position: relative; background: #dae3e7; }
        
        /* Panel Inferior */
        .results-panel { 
            height: 300px; background: var(--dark); color: #eee; overflow-y: auto; padding: 15px 25px; 
            font-family: 'Consolas', 'Courier New', monospace; font-size: 0.9rem;
            border-top: 4px solid var(--primary); box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
        }

        /* Estilos UI */
        h2 { color: var(--dark); margin-top: 0; font-size: 1.4rem; border-bottom: 3px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        h4 { margin: 15px 0 8px 0; color: var(--accent); font-size: 0.9rem; text-transform: uppercase; font-weight: 700; border-bottom: 1px solid #eee; padding-bottom: 4px;}
        .section-header { font-weight: bold; color: var(--dark); margin-top: 18px; margin-bottom: 8px; display: block; font-size: 1.05em;}

        .input-group { background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #e9ecef; margin-bottom: 12px; }
        .row { display: flex; gap: 10px; align-items: center; margin-bottom: 6px; }
        .row label { flex: 1.5; font-size: 0.85rem; font-weight: 600; color: #444; }
        .row input, .row select { flex: 1; padding: 6px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; width: 100%; }
        .row input[type="color"] { padding: 2px; height: 30px; }
        .coord-inputs { display: flex; gap: 4px; flex: 2; }
        .coord-inputs input { width: 100%; text-align: center; font-family: monospace; font-weight: 500; }

        /* Bot√≥n */
        .calc-button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; cursor: pointer; font-size: 1.1rem; font-weight: 800; border-radius: 6px; transition: all 0.2s; margin-top: 20px; box-shadow: 0 4px 6px rgba(214, 40, 40, 0.3); text-transform: uppercase; letter-spacing: 1px; }
        .calc-button:hover { background: #b51717; transform: translateY(-2px); }

        /* Tabs */
        .tabs { display: flex; background: #e9ecef; border-radius: 6px; padding: 4px; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-weight: 700; color: #666; border-radius: 4px; transition: 0.2s; text-transform: uppercase; font-size: 0.9rem; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Tablas Resultados */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
        th { text-align: left; color: #a8dadc; border-bottom: 2px solid #457b9d; padding: 8px; font-weight: 600; }
        td { padding: 8px; border-bottom: 1px solid #365b77; }
        .danger { color: #ff4d4d; font-weight: bold; } .warning { color: #ffd166; font-weight: bold; } .ok { color: #06d6a0; font-weight: bold; }
        .result-block h3 { color: var(--primary); margin-bottom: 5px; border-bottom: 1px solid #457b9d; }
        .result-footer { font-size: 0.85em; margin-top:8px; color:#aaa; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 4px;}
        
        /* Highlight para Offset */
        .highlight-input { border: 2px solid var(--primary) !important; background: #fff5f5; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Simulador FSAE Realista</h2>

        <div class="input-group" style="background: #e3f2fd; border-color: #bbdefb;">
            <div class="row">
                <label style="font-weight: 800; color: var(--dark);">VISUALIZACI√ìN:</label>
                <select id="viewMode" onchange="calculateAndPlot()" style="flex:1.5; font-weight:bold;">
                    <option value="both" selected>üöó Veh√≠culo Completo</option>
                    <option value="front">Solo Delantera</option>
                    <option value="rear">Solo Trasera</option>
                </select>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('front')">Geometr√≠a Delantera</div>
            <div class="tab" onclick="switchTab('rear')">Geometr√≠a Trasera</div>
        </div>
        <div id="active-inputs-container" class="input-group"></div>

        <span class="section-header">PAR√ÅMETROS GLOBALES</span>
        <div class="input-group">
            <h4>Maniobra y Fricci√≥n</h4>
            <div class="row"><label>G Frenado (Front):</label><input type="number" id="g_braking" value="1.7" step="0.1"></div>
            <div class="row"><label>G Aceleraci√≥n (Rear):</label><input type="number" id="g_accel" value="1.2" step="0.1"></div>
            <div class="row"><label>G Lateral (Curva):</label><input type="number" id="g_cornering" value="2.0" step="0.1"></div>
            <div class="row"><label>G Bump (Vertical):</label><input type="number" id="g_bump" value="3.0" step="0.1"></div>
            <div class="row"><label>Mu Longitudinal:</label><input type="number" id="mu_long" value="1.0" step="0.1"></div>
            <div class="row"><label>Mu Lateral:</label><input type="number" id="mu_lat" value="1.0" step="0.1"></div>

            <h4>Dimensiones y Masas</h4>
            <div class="row"><label>Wheelbase (mm):</label><input type="number" id="wheelbase" value="1650"></div>
            <div class="row"><label>Track Width Front (mm):</label><input type="number" id="track_front" value="1200"></div>
            <div class="row"><label>Altura CG (mm):</label><input type="number" id="cg_height" value="350"></div>
            <div class="row"><label>Masa Total (kg):</label><input type="number" id="m_total" value="365"> <small style="color:#666">(Veh√≠culo+Piloto)</small></div>
            <div class="row"><label>% Peso Delantero:</label><input type="number" id="weight_dist_front" value="0.4" step="0.01"></div>
            <div class="row"><label>Masa No Susp. Del (kg):</label><input type="number" id="unsprung_f" value="28"></div>
            <div class="row"><label>Masa No Susp. Tras (kg):</label><input type="number" id="unsprung_r" value="28"></div>
        </div>

        <span class="section-header">VISUALIZACI√ìN Y MATERIALES</span>
        <div class="input-group">
            <h4>Colores de Barras 3D</h4>
            <div class="row"><label>Color Compresi√≥n:</label><input type="color" id="color_comp" value="#0088ff"></div>
            <div class="row"><label>Color Tracci√≥n:</label><input type="color" id="color_tens" value="#ff0000"></div>

            <h4>Configuraci√≥n de Rueda (Visual)</h4>
            <div class="row"><label>OD Neum√°tico (mm):</label><input type="number" id="tire_od" value="520"></div>
            <div class="row"><label>Ancho Neum√°tico (mm):</label><input type="number" id="tire_width" value="205"></div>
            <div class="row"><label>OD Llanta (mm):</label><input type="number" id="rim_od" value="330"></div>
            <div class="row"><label style="color:var(--primary); font-weight:800;">Wheel Offset (mm):</label><input type="number" id="wheel_offset" value="45" class="highlight-input"></div>
             <div style="font-size:0.8em; color:#666; margin-bottom:10px;">(Offset positivo mete el buje hacia adentro de la llanta)</div>

            <h4>Tubos (SAE 1026)</h4>
            <div class="row"><label>Fluencia (MPa):</label><input type="number" id="mat_yield" value="310"></div>
            <div class="row"><label>Mod. Young (GPa):</label><input type="number" id="mat_E" value="210"></div>
            <div class="row"><label>OD Tubo (mm):</label><input type="number" id="tube_od" value="20"></div>
            <div class="row"><label>ID Tubo (mm):</label><input type="number" id="tube_id" value="0"></div>
            <div class="row"><label>FS Objetivo:</label><input type="number" id="sf_target" value="3.5" step="0.1"></div>
        </div>

        <span class="section-header">TREN DE POTENCIA (TRASERA)</span>
        <div class="input-group">
             <h4>Datos Palier</h4>
            <div class="row"><label>Torque Max Motor (Nm):</label><input type="number" id="eng_torque" value="120"></div>
            <div class="row"><label>Reducci√≥n Total:</label><input type="number" id="gear_ratio" value="4.0" step="0.1"></div>
            <div class="row"><label>Eficiencia Trans.:</label><input type="number" id="drivetrain_eff" value="0.95" step="0.01"></div>
            <div class="row"><label>OD Palier (mm):</label><input type="number" id="palier_od" value="22.0"></div>
            <div class="row"><label>ID Palier (mm):</label><input type="number" id="palier_id" value="0.0"></div>
        </div>

        <button class="calc-button" onclick="calculateAndPlot()">‚ö° EJECUTAR SIMULACI√ìN</button>
        <br><br>
    </div>

    <div class="main-content">
        <div id="plot3d" class="viz-container"></div>
        <div class="results-panel">
            <div id="results-output">
                <div style="text-align: center; padding-top: 100px; color: #aaa;">Cargando motor de simulaci√≥n...</div>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // 1. GESTI√ìN DE DATOS Y ESTADO
    // ==========================================
    let editingAxle = 'front';
    const val = (id) => parseFloat(document.getElementById(id).value) || 0;
    const col = (id) => document.getElementById(id).value;

    // Hardpoints Iniciales (COORDENADAS LOCALES seg√∫n tu √∫ltimo prompt)
    const vehicleData = {
        front: {
            tire_center: [0.0, 0.58675, 0.2525],
            lwb_f: [-0.07990, 0.26455, 0.12523], lwb_r: [0.07990, 0.26455, 0.12523], lwb_u: [0.0, 0.58434, 0.14852],
            uwb_f: [-0.05435, 0.24249, 0.28878], uwb_r: [0.093, 0.24249, 0.27284], uwb_u: [0.0301, 0.55383, 0.35648],
            push_c: [0.0, 0.2, 0.5], push_u: [0.0, 0.5, 0.25],
            tie_c: [-0.100, 0.270, 0.160], tie_u: [-0.100, 0.520, 0.160],
            p_trail_mm: 30.0
        },
        rear: {
            tire_center: [0.0, 0.58675, 0.2525],
            lwb_f: [-0.07990, 0.26455, 0.12523], lwb_r: [0.07990, 0.26455, 0.12523], lwb_u: [0.0, 0.58434, 0.14852],
            uwb_f: [-0.05435, 0.24249, 0.28878], uwb_r: [0.093, 0.24249, 0.27284], uwb_u: [0.0301, 0.55383, 0.35648],
            push_c: [0.0, 0.2, 0.5], push_u: [0.0, 0.5, 0.25],
            tie_c: [-0.100, 0.270, 0.160], tie_u: [-0.100, 0.520, 0.160],
            p_trail_mm: 30.0
        }
    };

    function switchTab(axle) {
        editingAxle = axle;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        renderInputs();
    }

    function renderInputs() {
        const d = vehicleData[editingAxle];
        const container = document.getElementById('active-inputs-container');
        container.innerHTML = `<h4>Hardpoints ${editingAxle.toUpperCase()} [X, Y, Z] (Local)</h4>`;
        const points = {
            'tire_center': 'Centro Rueda', 'lwb_f': 'LWB Chas F', 'lwb_r': 'LWB Chas R', 'lwb_u': 'LWB Uprt',
            'uwb_f': 'UWB Chas F', 'uwb_r': 'UWB Chas R', 'uwb_u': 'UWB Uprt',
            'push_c': 'Push Chas', 'push_u': 'Push Uprt',
            'tie_c': editingAxle==='front'?'Tie Chas':'Toe Chas', 'tie_u': editingAxle==='front'?'Tie Uprt':'Toe Uprt'
        };
        for (const [key, label] of Object.entries(points)) {
            container.innerHTML += `<div class="row"><label>${label}</label><div class="coord-inputs">
                <input type="number" value="${d[key][0]}" step="0.005" onchange="updateData('${key}',0,this.value)">
                <input type="number" value="${d[key][1]}" step="0.005" onchange="updateData('${key}',1,this.value)">
                <input type="number" value="${d[key][2]}" step="0.005" onchange="updateData('${key}',2,this.value)">
            </div></div>`;
        }
        container.innerHTML += `<div class="row" style="margin-top:10px; border-top:1px solid #eee; padding-top:8px;">
            <label>Pneumatic Trail (mm):</label><input type="number" value="${d.p_trail_mm}" onchange="updateScalar('p_trail_mm',this.value)"></div>`;
    }
    function updateData(k,i,v){vehicleData[editingAxle][k][i]=parseFloat(v);}
    function updateScalar(k,v){vehicleData[editingAxle][k]=parseFloat(v);}

    // ==========================================
    // 2. MOTOR MATEM√ÅTICO (SOLVER)
    // ==========================================
    const sub=(a,b)=>[a[0]-b[0],a[1]-b[1],a[2]-b[2]]; const add=(a,b)=>[a[0]+b[0],a[1]+b[1],a[2]+b[2]];
    const norm=(v)=>Math.sqrt(v[0]**2+v[1]**2+v[2]**2); const normalize=(v)=>{const n=norm(v);return n===0?[0,0,0]:[v[0]/n,v[1]/n,v[2]/n];};
    const cross=(a,b)=>[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]];

    function solveLinearSystem(A,B){let n=B.length;let M=A.map(r=>[...r]);let x=[...B];for(let i=0;i<n;i++){let max=Math.abs(M[i][i]),row=i;for(let k=i+1;k<n;k++){if(Math.abs(M[k][i])>max){max=Math.abs(M[k][i]);row=k;}}for(let k=i;k<n;k++){let t=M[row][k];M[row][k]=M[i][k];M[i][k]=t;}let t=x[row];x[row]=x[i];x[i]=t;for(let k=i+1;k<n;k++){let c=-M[k][i]/M[i][i];for(let j=i;j<n;j++){if(i===j)M[k][j]=0;else M[k][j]+=c*M[i][j];}x[k]+=c*x[i];}}let res=new Array(n).fill(0);for(let i=n-1;i>-1;i--){let s=0;for(let j=i+1;j<n;j++)s+=M[i][j]*res[j];res[i]=(x[i]-s)/M[i][i];}return res;}

    function calculateAxle(axleType, data, inputs) {
        const g=9.81; const tc=data.tire_center;
        const vl_f=normalize(sub(data.lwb_u,data.lwb_f)), vl_r=normalize(sub(data.lwb_u,data.lwb_r));
        const vu_f=normalize(sub(data.uwb_u,data.uwb_f)), vu_r=normalize(sub(data.uwb_u,data.uwb_r));
        const vp=normalize(sub(data.push_u,data.push_c)), vt=normalize(sub(data.tie_u,data.tie_c));

        const total_m = inputs.m_total; const unsprung = (2*inputs.unsprung_f)+(2*inputs.unsprung_r);
        const suspended = total_m - unsprung; let mass_corner=0;

        if(axleType==='front'){
            const susp_f = suspended * inputs.weight_dist_front;
            const static_f = (susp_f/2) + inputs.unsprung_f;
            const trans_lo = (total_m*inputs.g_braking*inputs.cg_height)/inputs.wheelbase;
            const dyn_f = (static_f*2)+trans_lo;
            const trans_la = (dyn_f*inputs.g_cornering*inputs.cg_height)/inputs.track_front;
            mass_corner = (dyn_f/2)+trans_la;
        }else{
            const susp_r = suspended*(1-inputs.weight_dist_front);
            const static_r = (susp_r/2) + inputs.unsprung_r;
            const trans_lo = (total_m*inputs.g_accel*inputs.cg_height)/inputs.wheelbase;
            const dyn_r = (static_r*2)+trans_lo;
            const trans_la = (dyn_r*inputs.g_cornering*inputs.cg_height)/inputs.track_front;
            mass_corner = (dyn_r/2)+trans_la;
        }

        const Fz = mass_corner*g*inputs.g_bump;
        let Fx = Math.min(mass_corner*g*(axleType==='front'?inputs.g_braking:inputs.g_accel), Fz*inputs.mu_long);
        if(axleType==='front') Fx*=-1;
        const Fy = Math.min(mass_corner*g*inputs.g_cornering, Fz*inputs.mu_lat);
        const F_g = [Fx,Fy,Fz];

        const cp_eff = [tc[0]-(data.p_trail_mm/1000), tc[1], 0.0];
        const M_g = cross(sub(cp_eff,tc), F_g);
        let trqRem=0; if(axleType==='rear'){ trqRem=M_g[1]; M_g[1]=0; }

        const rl=sub(data.lwb_u,tc), ru=sub(data.uwb_u,tc), rp=sub(data.push_u,tc), rt=sub(data.tie_u,tc);
        const ml_f=cross(rl,vl_f), ml_r=cross(rl,vl_r), mu_f=cross(ru,vu_f), mu_r=cross(ru,vu_r), mp=cross(rp,vp), mt=cross(rt,vt);

        const A=[
            [vl_f[0],vl_r[0],vu_f[0],vu_r[0],vp[0],vt[0]], [vl_f[1],vl_r[1],vu_f[1],vu_r[1],vp[1],vt[1]], [vl_f[2],vl_r[2],vu_f[2],vu_r[2],vp[2],vt[2]],
            [ml_f[0],ml_r[0],mu_f[0],mu_r[0],mp[0],mt[0]], [ml_f[1],ml_r[1],mu_f[1],mu_r[1],mp[1],mt[1]], [ml_f[2],ml_r[2],mu_f[2],mu_r[2],mp[2],mt[2]]
        ];
        const B=[-F_g[0],-F_g[1],-F_g[2],-M_g[0],-M_g[1],-M_g[2]];
        let res=[0,0,0,0,0,0]; try{res=solveLinearSystem(A,B);}catch(e){console.error(e);}
        return {forces:res, loads:{Fx,Fy,Fz}, geo:data, massCorner:mass_corner, trqRem};
    }

    // ==========================================
    // 3. VISUALIZACI√ìN 3D REALISTA (NUEVA VERSI√ìN)
    // ==========================================
    function createRealisticWheelV2(center, tireOD, tireWidth, rimOD, offset, upLow, upUpp) {
        const traces = [];
        const rTire = tireOD/2000, rRim = rimOD/2000, w = tireWidth/1000, off = offset/1000;
        
        // Calcular Camber
        const kp = sub(upUpp, upLow);
        // √Ångulo respecto a la vertical Z en el plano YZ. (Asumiendo Y+ es hacia adentro del coche)
        const camber = Math.atan2(kp[1], kp[2]); // Radianes. Positivo si la parte superior se mete en Y.

        // Funci√≥n rotaci√≥n simple alrededor de X local (Camber)
        const rot = (y,z) => [ y*Math.cos(camber) - z*Math.sin(camber), y*Math.sin(camber) + z*Math.cos(camber) ];

        // Generador de Superficies de Revoluci√≥n
        const makeSurf = (radiusFunc, widthFunc, yOffset, color, metallic, name) => {
            const theta=[], y=[], x_s=[], y_s=[], z_s=[];
            const steps=45, w_steps=10;
            for(let i=0; i<=steps; i++) theta.push((i/steps)*2*Math.PI);
            for(let i=0; i<=w_steps; i++) y.push((i/w_steps)); // 0 a 1
            
            for(let i=0; i<y.length; i++) {
                let rX=[], rY=[], rZ=[];
                const curY_local = widthFunc(y[i]);
                const curR = radiusFunc(y[i]);
                for(let j=0; j<theta.length; j++) {
                    const bx = curR * Math.cos(theta[j]);
                    const bz = curR * Math.sin(theta[j]);
                    const [ry, rz] = rot(curY_local, bz);
                    rX.push(center[0] + bx);
                    rY.push(center[1] + ry + yOffset);
                    rZ.push(center[2] + rz);
                }
                x_s.push(rX); y_s.push(rY); z_s.push(rZ);
            }
            return { type:'surface', x:x_s, y:y_s, z:z_s, colorscale:[[0,color],[1,color]], showscale:false, 
                     lighting:{ambient:0.3, diffuse:0.8, specular:metallic?1.5:0.1, roughness:metallic?0.2:0.9}, name, hoverinfo:'skip' };
        };

        // 1. Neum√°tico (Toroide achatado)
        // Perfil lateral redondeado
        const tireProfileR = (t) => rTire - (w*0.15)*Math.pow(2*t-1, 2); // Radio variable
        const tireProfileW = (t) => w*(t-0.5); // Ancho de -w/2 a w/2
        traces.push(makeSurf(tireProfileR, tireProfileW, 0, '#1a1a1a', false, 'Neum√°tico'));

        // 2. Llanta Exterior (Cara s√≥lida plateada)
        const rimFaceW = (t) => -w/2 + 0.002; // Posici√≥n fija en Y (borde exterior)
        const rimFaceR = (t) => rRim * t; // Radio de 0 a rRim (disco completo)
        traces.push(makeSurf(rimFaceR, rimFaceW, 0, '#c0c0c0', true, 'Llanta Exterior'));

        // 3. Llanta Interior con Profundidad (El "balde" del offset)
        // Conecta el borde interior de la llanta con el plano de montaje del buje.
        // t=0 -> Borde interior de llanta (Y = +w/2, R = rRim)
        // t=1 -> Plano de montaje buje (Y = +offset, R = radio peque√±o del buje)
        const hubR = 0.04; // Radio del centro del buje
        const innerRimW = (t) => (w/2)*(1-t) + (off)*t; // Interpola Y desde w/2 hasta offset
        const innerRimR = (t) => rRim*(1-t) + hubR*t;  // Interpola R desde rRim hasta hubR
        // Usamos un color gris m√°s oscuro para dar sensaci√≥n de profundidad/sombra
        traces.push(makeSurf(innerRimR, innerRimW, 0, '#777777', true, 'Interior Llanta'));

        return traces;
    }

    // ==========================================
    // 4. CONTROLADOR PRINCIPAL
    // ==========================================
    function calculateAndPlot() {
        const inputs = {
            g_braking: val('g_braking'), g_accel: val('g_accel'), g_cornering: val('g_cornering'), g_bump: val('g_bump'),
            mu_long: val('mu_long'), mu_lat: val('mu_lat'), wheelbase: val('wheelbase')/1000,
            track_front: val('track_front')/1000, cg_height: val('cg_height')/1000, m_total: val('m_total'),
            weight_dist_front: val('weight_dist_front'), unsprung_f: val('unsprung_f'), unsprung_r: val('unsprung_r')
        };
        const vi = { tire_od: val('tire_od'), tire_width: val('tire_width'), rim_od: val('rim_od'), wheel_offset: val('wheel_offset') };
        const colors = { comp: col('color_comp'), tens: col('color_tens') };
        
        const viewMode = document.getElementById('viewMode').value;
        let plots = [], html = "";

        if(viewMode!=='rear') {
            const resF = calculateAxle('front', vehicleData.front, inputs);
            plots = plots.concat(generateTraces(resF, 0, vi, colors, "Front"));
            html += generateTable("SUSP. DELANTERA", resF, 'front');
        }
        if(viewMode!=='front') {
            const resR = calculateAxle('rear', vehicleData.rear, inputs);
            plots = plots.concat(generateTraces(resR, inputs.wheelbase, vi, colors, "Rear"));
            html += generateTable("SUSP. TRASERA", resR, 'rear');
            html += calcPowertrain(resR.loads.Fx);
        }

        document.getElementById('results-output').innerHTML = html;
        
        const layout = {
            margin:{l:0,r:0,b:0,t:0}, paper_bgcolor:'#dae3e7', plot_bgcolor:'#dae3e7',
            scene: {
                aspectmode: "data",
                xaxis:{title:'X (Longitudinal)', backgroundcolor:'#d0dce0'},
                yaxis:{title:'Y (Transversal)', backgroundcolor:'#d0dce0'},
                zaxis:{title:'Z (Vertical)', backgroundcolor:'#e0e8ec'},
                camera: {eye:{x:1.8,y:-1.8,z:1.0}, up:{x:0,y:0,z:1}, center:{x:0,y:0,z:-0.2}},
                dragmode: 'orbit'
            }, showlegend: true, legend:{x:0,y:1,bgcolor:'rgba(255,255,255,0.5)'}
        };
        Plotly.react('plot3d', plots, layout, {displayModeBar: true, modeBarButtonsToRemove:['toImage']});
    }

    function generateTraces(res, xOff, vi, co, lbl) {
        const g=res.geo; const f=res.forces; const pos=(p)=>[p[0]+xOff,p[1],p[2]];
        const links=[
            {n:"LWB F",f:f[0],p1:g.lwb_f,p2:g.lwb_u},{n:"LWB R",f:f[1],p1:g.lwb_r,p2:g.lwb_u},
            {n:"UWB F",f:f[2],p1:g.uwb_f,p2:g.uwb_u},{n:"UWB R",f:f[3],p1:g.uwb_r,p2:g.uwb_u},
            {n:"Pushrod",f:f[4],p1:g.push_c,p2:g.push_u},{n:lbl==='Front'?"Tie Rod":"Toe Link",f:f[5],p1:g.tie_c,p2:g.tie_u}
        ];
        const traces = links.map(l=>{
            const p1=pos(l.p1), p2=pos(l.p2); const absF=Math.abs(l.f);
            return { type:'scatter3d', mode:'lines+markers', x:[p1[0],p2[0]], y:[p1[1],p2[1]], z:[p1[2],p2[2]],
                line:{color:l.f>0?co.comp:co.tens, width:Math.max(4,Math.min(14,absF/1000))},
                marker:{size:4,color:'#222'}, name:`${lbl} ${l.n}`, hoverinfo:'text', text:`${l.n}: ${l.f.toFixed(0)} N` };
        });
        traces.push({type:'scatter3d', mode:'markers', x:[pos(g.tire_center)[0]], y:[pos(g.tire_center)[1]], z:[0], marker:{symbol:'cross',size:6,color:'#333'}, name:'Suelo Ref', hoverinfo:'skip'});
        
        // Usar la nueva funci√≥n de rueda realista V2
        const wheel = createRealisticWheelV2(pos(g.tire_center), vi.tire_od, vi.tire_width, vi.rim_od, vi.wheel_offset, pos(g.lwb_u), pos(g.uwb_u));
        wheel.forEach(t => t.name = lbl + ' ' + t.name); // Prefijo para leyenda

        return [...traces, ...wheel];
    }

    // ==========================================
    // 5. RESULTADOS HTML
    // ==========================================
    function generateTable(title, res, type) {
        const names = type==='front' ? ["LWB Front","LWB Rear","UWB Front","UWB Rear","Pushrod","Tie Rod"] : ["LWB Front","LWB Rear","UWB Front","UWB Rear","Pushrod","Toe Link"];
        const yieldS=val('mat_yield'), E=val('mat_E')*1e9, od=val('tube_od')/1000, id=val('tube_id')/1000, sf=val('sf_target');
        const area=(Math.PI/4)*(od**2-id**2), I=(Math.PI/64)*(od**4-id**4);

        let html=`<div class="result-block"><h3>${title}</h3><table><tr><th>Barra</th><th>Fuerza (N)</th><th>Stress (MPa)</th><th>FS Yield</th><th>FS Buckling</th></tr>`;
        res.forces.forEach((f,i)=>{
            const s=f>0?"C":"T", stress=(Math.abs(f)/area)/1e6, fsY=yieldS/stress;
            let fsB="N/A", bc="";
            if(f>0){
                const p1=Object.values(res.geo)[i*3+1], p2=Object.values(res.geo)[i*3+3];
                if(p1&&p2){ const L=norm(sub(p1,p2)), Pcr=(Math.PI**2*E*I)/(L**2), fb=Pcr/f; fsB=fb.toFixed(1); if(fb<sf) bc=fb<1?"danger":"warning"; }
            }
            html+=`<tr><td><strong>${names[i]}</strong></td><td style="color:${f>0?col('color_comp'):col('color_tens')}">${f.toFixed(0)} (${s})</td><td>${stress.toFixed(1)}</td><td class="${fsY<sf?(fsY<1.5?"danger":"warning"):"ok"}">${fsY.toFixed(1)}</td><td class="${bc}">${fsB}</td></tr>`;
        });
        return html+`</table><div class="result-footer">Cargas Parche: Fx=${res.loads.Fx.toFixed(0)}, Fy=${res.loads.Fy.toFixed(0)}, Fz=${res.loads.Fz.toFixed(0)} N${res.trqRem?`. Torque removido: ${res.trqRem.toFixed(0)} Nm`:''}</div></div><br>`;
    }

    function calcPowertrain(Fx){
        const T_eng=val('eng_torque'), gr=val('gear_ratio'), eff=val('drivetrain_eff'), pod=val('palier_od')/1000, pid=val('palier_id')/1000, rTire=val('tire_od')/2000;
        const T_whl=T_eng*gr*eff, T_grip=Fx*rTire, T_des=Math.min(T_whl,T_grip);
        const Sy_shear=900*0.58, J=(Math.PI/32)*(pod**4-pid**4), tau=(T_des*pod/2)/J/1e6, fs=Sy_shear/tau;
        return `<div class="result-block" style="border-top:4px solid #fca311"><h3>TREN DE POTENCIA (PALIER 4340)</h3><table><tr><th>Par√°metro</th><th>Valor</th><th>Estado</th></tr>
        <tr><td>Torque Dise√±o</td><td>${T_des.toFixed(1)} Nm</td><td>Limited by ${T_whl<T_grip?'Engine':'Grip'}</td></tr>
        <tr><td>Stress Cortante</td><td>${tau.toFixed(1)} MPa</td><td>Sy Shear = 522 MPa</td></tr>
        <tr><td><strong>FS Torsi√≥n</strong></td><td><strong>${fs.toFixed(2)}</strong></td><td class="${fs<3.5?(fs<2?"danger":"warning"):"ok"}">${fs<3.5?"Revisar":"OK"}</td></tr></table></div>`;
    }

    switchTab('front');
    setTimeout(calculateAndPlot, 800);
</script>
</body>
</html>